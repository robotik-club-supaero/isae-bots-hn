![logo isae-robotics-club](../.media/isae_robotics_logo.png)

>**Attention** : Ce tutoriel est une ébauche et n'est pas encore entièrement testé.

# Configuration du Raspberry Pi

## Prérequis :

- ### Le tutoriel "Téléchargement du code" et les prérequis du tutoriel "Installation Docker"

- ### Soit un ordinateur avec architecture ARM64 (par ex. le Raspberry), soit QEMU.

Pour installer QEMU :
```
docker run --privileged --rm tonistiigi/binfmt --install arm64
```

#### Attention
- Si vous choisissez QEMU, la création de l'image Docker risque de prendre beaucoup de temps.
- Dans les deux cas, vous avez besoin d'un accès à internet (vous ne pouvez pas utiliser le réseau "Robotik"). Si vous vous connectez à un autre réseau que "Robotik" sur le Raspberry, assurez-vous de vous reconnecter à Robotik quand vous avez fini de créer l'image.

## Créer l'image Docker

Vous devez vous placer dans le répertoire où vous avez téléchargé le code, par exemple : `cd ~/Documents/isae-bots-hn-2024`.

```
make build-image-pi
```

Si vous avez une erreur `exec format error`, vérifiez que vous avez bien installé QEMU. La commande `docker buildx ls` doit afficher `linux/arm64` dans la liste des plateformes prises en charge.

## Mettre l'image sur le Raspberry

Si vous avez créé l'image directement sur le Raspberry, vous pouvez sauter cette section.

- ### Exporter l'image
```bash
# Sur le PC :
docker save -o image_pi_env_full_2.0.tar isaebots_pi_env_full:2.0
```

- ### Vérifier l'espace disque libre sur le Raspberry

Si nécessaire, supprimez les anciens fichiers ou les anciennes images Docker :
```bash
# Sur le Raspberry :
docker images
docker image rm <image_id>
```
Si vous avez un doute, sauvegardez les fichiers avant de les supprimer.

- ### Copier l'image sur le Raspberry

Copiez le fichier `image_pi_env_full_2.0.tar` que vous venez de créer sur le Raspberry. Vous pouvez soit utiliser une clé USB (recommandé), soit transférer l'image en SSH (voir la section "Connexion en SSH au Raspberry" pour plus d'informations) :
```bash
# Sur le PC :
scp image_pi_env_full_2.0.tar pi@192.168.1.11
```

- ### Importer l'image
```bash
# Sur le Raspberry :
docker load -i image_pi_env_full_2.0.tar
```

## Créer le conteneur

Voir le tutoriel "Installation Docker".

## Connexion en SSH au Raspberry

Connectez votre ordinateur et le Raspberry au réseau "Robotik" (le Raspberry du club est censé s'y connecter automatiquement). Le mot de passe du routeur est `bonjour01`.

- Adresse IP du Raspberry : `192.168.1.11`
- Nom d'utilisateur : `pi`
- Mot de passe : `r`

Exemple :
```
ssh pi@192.168.1.11
```

## Mettre le code sur le Raspberry

N'utilisez pas `git clone` ou `git pull` sur le Raspberry car, la plupart du temps (notamment à la coupe), le Raspberry n'est pas connecté à internet. Pour la même raison, ne modifiez pas directement le code sur le Raspberry car les modifications risqueraient d'être écrasées.

Le script `uploadSourceFiles.sh` permet de copier via SSH le code depuis votre PC vers le Raspberry. (Voir la section "Connexion en SSH au Raspberry" ci-dessus.)

**Attention** : Si la BR a été modifiée après la création du conteneur sur le Raspberry, vous devez copier les modifications sur le Docker et recompiler la BR (voir `dev/lib/README.md`).

```bash
# Sur le PC :
./uploadSourceFiles.sh

# Puis sur le Raspberry (uniquement si la BR a été modifiée) :
docker cp ./dev/lib/br/. isaebots:/app/dev/lib/br
make main CMD="colcon build --symlink-install"
```
## Exécuter le code sur le Raspberry

Voir le tutoriel "Exécuter le code". La seule différence est que les applications graphiques ne fonctionneront pas pour la plupart.