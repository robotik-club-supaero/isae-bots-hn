![logo isae-robotics-club](../.media/isae_robotics_logo.png)

>**Attention** : Ce tutoriel est une ébauche et n'est pas encore entièrement testé.

**Il est recommandé d'avoir suivi les tutoriels sur PC avant de suivre ce tutoriel.**

# Configuration du Raspberry Pi

## Installation du système d'exploitation

Vous avez besoin d'un ordinateur avec un lecteur de carte SD.
Utilisez `rpi-imager` : https://www.raspberrypi.com/software/.
- Modèle : sélectionnez le modèle du Raspberry à utiliser
- Système d'exploitation : Cliquez sur `Raspberry Pi Os (other)` puis choisissez `Raspberry Pi OS Lite` (sans interface graphique)
- Stockage : Choisissez la carte SD. Si nécessaire, sauvegardez ses données avant de poursuivre car elles seront effacées.

Cliquez sur "Suivant" puis "Modifier la configuration".

Configuration initiale recommandée 
- Onglet "Général" :
    * Nom d'hôte : `robot`.local
    * Nom d'utilisateur : `pi`
    * Mot de passe : `r`
    * Wifi : mettez les identifiants d'un réseau Wifi qui fournit un accès à internet.
    * Pays Wifi : `FR`
    * Fuseau horaire : `Europe/Paris`
    * Type de clavier : `fr`
- Onglet "Services" :
    * Activez SSH et cochez "Utiliser un mot de passe pour l'authentification."

Cliquez sur "Enregistrer" puis sur "Oui".

Attendez la fin de l'installation, mettez la carte SD dans le Raspberry et démarrez le Raspberry.

## Configuration du Raspberry

>Même si on a activé l'accès SSH, il est conseillé d'utiliser un clavier et un écran pour la configuration initiale du Raspberry car certaines étapes peuvent nécessiter de se déconnecter temporairement d'internet.

**Mettez à jour le système :**

```
sudo apt update
sudo apt upgrade
```

**Activez l'I2C :**

```bash
sudo raspi-config
# Interface Options -> I2C -> Yes
```

**Installez make**

```
sudo apt install make
```

## Téléchargement du code HN

Reportez-vous au tutoriel "Téléchargement du code HN".
>Mettez le code dans `/home/pi` ou `~` (équivalent), et non dans `Documents` -- sinon certains scripts ne fonctionneront pas correctement.

## Installation de Docker

Si vous avez un système 32-bits, suivez le tutoriel pour Raspberry Pi : https://docs.docker.com/engine/install/raspberry-pi-os/

Sinon, suivez le tutoriel pour Debian : https://docs.docker.com/engine/install/debian/

Suivez aussi le tutoriel post-installation pour pouvoir utiliser Docker sans `sudo` : https://docs.docker.com/engine/install/linux-postinstall/.

## Création de l'image Docker

Si vous ne l'avez pas fait à l'étape précédente, redémarrez le Raspberry.

L'image Docker du Raspberry est différente de l'image PC. En effet, l'image du Raspberry ne contient pas les bibliothèques graphiques (TKinter, SFML, ...) mais contient à la place des bibliothèques pour communiquer avec le GPIO et les autres périphériques.

```
cd ~/isae-bots-hn-2024

make build-image-pi
```

>#### Remarque :
>Cette étape est longue. Si la création de l'image prend trop de temps, vous pouvez l'interrompre à la fin d'une étape (avec Ctrl + C) et la reprendre plus tard en refaisant la commande `make build-image-pi`. En effet, Docker enregistre la progression à la fin de chaque étape. En revanche, évitez d'interrompre l'opération au milieu d'une étape longue.

>#### Remarque :
>Si vous souhaitez construire l'image sur PC et la transférer ensuite sur le Raspberry, reportez-vous à la section dédiée à la fin de ce tutoriel.

## Création du conteneur

Les commandes sont les mêmes que sur PC :

```bash
make create-container # Pour le créer
make clear-container # Pour le remplacer ou le réinitialiser
```

## Exécuter le code sur le Raspberry

Voir le tutoriel "Exécuter le code". La seule différence est que les applications graphiques ne fonctionneront pas pour la plupart.

# Annexe 1 - Connexion à Robotik

Une fois que le Raspberry est configuré et n'a plus besoin de connexion à internet, il est conseillé de le connecter à `Robotik`.

> Cette étape ne peut pas être faite via SSH !

- Branchez le routeur et attendez qu'il démarre
- Sur le Raspberry :

```bash
sudo nmtui
# "Activate a connection" -> sélectionnez "Robotik"
# Mot de passe : `bonjour01`
```

>N'oubliez pas d'apporter le routeur (et le cable d'alimentation) à la coupe !

> Vous serez très problablement amené à modifier le code HN après cette étape. Consultez les annexes ci-dessous pour répercuter les modifications sur le Raspberry.

# Annexe 2 - Connexion en SSH

Lorsque votre PC est connecté au même réseau Wifi que le Raspberry, vous pouvez vous connecter en SSH au Raspberry à l'adresse `robot.local` :

```bash
ssh pi@robot.local
# Mot de passe : `r`
```

# Annexe 3 - Mettre à jour le code

Ne modifiez pas le code directement sur le Raspberry, car les modifications risqueraient d'être écrasées.

Le script `uploadSourceFiles.sh` permet de mettre à jour le code du HN sur le Raspberry (en utilisant SSH) même s'il n'est pas connecté à internet. Le mot de passe est encore `r`. Votre PC doit être connecté au même réseau Wifi que le Raspberry.

**Si la BR a été modifiée**, vous devez la recompiler :

```bash
# cd ~/isae-bots-hn-2024 # Si nécessaire
make main CMD="colcon build --symlink-install"
```

Voir `dev/lib/README.md` pour plus d'informations sur la gestion de la BR.

# Annexe 4 - Création de l'image depuis un PC

>Si vous avez accès à un Raspberry performant, il est beaucoup plus rapide de construire l'image directement dessus plutôt que de suivre cette annexe.

## Créer l'image

L'image doit être créée pour une architecture ARM64. Si vous avez une architecture x86_64, vous devez activer l'émulateur QEMU avant de construire l'image :
```
docker run --privileged --rm tonistiigi/binfmt --install arm64
```

>Attention, la création de l'image ARM sur un PC x86_64 est TRES longue (prévoyez la journée entière).

La commande pour créer l'image est la même que sur Raspberry : `make build-image-pi`.

>Si vous avez une erreur `exec format error`, vérifiez que vous avez bien activé QEMU. La commande `docker buildx ls` doit afficher `linux/arm64` dans la liste des plateformes prises en charge. Vous devrez probablement re-faire l'étape d'activation si vous redémarrez l'ordinateur. 

## Exporter l'image

```bash
# Sur le PC :
docker save -o image_pi_env_full_2.0.tar isaebots_pi_env_full:2.0
```

Copiez le fichier `image_pi_env_full_2.0.tar` que vous venez de créer sur le Raspberry (soit en insérant directement la carte SD du Raspberry dans un lecteur de carte SD, soit en utilisant une clé USB intermédiaire, soit par SSH (plus long)).

```bash
# Sur le PC (si vous choisissez SSH) :
scp image_pi_env_full_2.0.tar pi@robot.local:/home/pi/
```

## Importer l'image sur le Raspberry

```bash
# Sur le Raspberry :
docker load -i ~/image_pi_env_full_2.0.tar
```

>Cette étape prend à nouveau du temps. Si rien ne s'affiche pendant plusieurs minutes après avoir tapé la commande, c'est normal. Ne l'interrompez pas.

Vous pouvez maintenant créer le conteneur normalement.

# Annexe 5 - Mise à jour de `usb-serial.rules`

Pour donner un nom reconnaissable à un périphérique série dans `/dev/tty***`, suivez cette annexe.

- Déconnectez tous les périphériques non indispensables, sauf le périphérique à configurer.

- Affichez la liste des périphériques :
```bash
sudo lsusb

# Va afficher une liste de la forme :
# Bus XXX Device YYY: ID ZZZ:ZZZ <Nom du périphérique>
```

- Repérez le numéro `YYY` du périphérique à configurer.
(Vous pouvez refaire la commande après avoir déconnecté le périphérique pour trouver celui qui a disparu de la liste.)

- Affichez les informations sur le péripérique :
```bash
sudo lsusb -s YYY -v
```

- Cherchez en particulier les attributs `idVendor`, `idProduct` et `serial`. Utilisez ces informations pour ajouter une ligne au fichier `install/10-usb-serial.rules` (ou remplacer une ligne existante correspondante) :

```
SUBSYSTEM=="tty", ATTRS{idVendor}=="abcd", ATTRS{idProduct}=="abcd", ATTRS{serial}=="XXXXXXXX", SYMLINK+="ttyNAME"
```

Remplacez `abcd` par les quatre chiffres hexadécimaux correspondant à `idVendor` et `idProduct`, respectivement. Remplacez `XXXXXXXX` par le numéro de série. Remplacer `NAME` par le nom que vous souhaitez donner au périphérique.

- Enfin, copiez le nouveau fichier `10-usb-serial.rules` dans le conteneur Docker du Raspberry, à l'emplacement indiqué : `/etc/udev/rules.d/10-usb-serial.rules`. Redémarrez le Raspberry pour que les changements prennent effet.

> L'ancien nom `ttyACMX` ou `ttyUSBX` sera toujours présent dans `/dev`, mais il devrait désormais également y avoir un lien symbolique avec le nom demandé.